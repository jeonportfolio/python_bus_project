<!DOCTYPE html>
<html>
<head>
    <title>정류소 찾기</title>
    <meta charset="UTF-8">
    <style>
        /* 전체 페이지의 기본 스타일 설정 */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
        }
        /* 섹션 스타일 */
        .section {
            width: 100%;
            box-sizing: border-box;
            padding: 20px;
            border-bottom: 1px solid #ccc; /* 구분선을 위해 */
        }
        /* 버튼 스타일 */
        .find-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border: none;
            cursor: pointer;
        }

        .find-search {
            display: inline-block;
            padding: 10px 20px;
            background-color: #444444;
            color: white;
            text-decoration: none;
            border: none;
            cursor: pointer;
        }        
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>        
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=183616ffedc4fe407528d90f085a9af6&libraries=services"></script>     
    <script>
         var psStart = new kakao.maps.services.Places();
        var map = null;
        var markers = [];
        var infowindow = new kakao.maps.InfoWindow({zIndex:1});
        function findStartStation() {
            $("#mapContainer").show();

            var mapContainer = document.getElementById('mapStart'), // 지도를 표시할 div 
                mapOption = { 
                    center: new kakao.maps.LatLng(37.5664056, 126.9778222), // 지도의 중심좌표
                    level: 3 // 지도의 확대 레벨
                };

            // 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
            map = new kakao.maps.Map(mapContainer, mapOption);             
            var stationInfo = getStationByPositionSync("126.9778222", "37.5664056");
            console.log(stationInfo);
        }

        function getStationByPositionSync(x, y) {
            var data = {
                "x": x,
                "y": y
            };

            var result = null; //결과를 저장할 변수

            $.ajax({
                url: '/busstationservice',
                type: 'POST',
                contentType: 'application/json',
                dataType: 'text',
                data: JSON.stringify(data),
                async: false, // 작업 편의를 위해 동기 요청으로 설정 (비동기는 이 함수 실행시에도 다른 코드가 실행됨)
                success: function(response) {
			        //성공할 경우
                    result = response;
                },
                error: function(xhr, status, error) {
		        // 오류 발생 시 실행될 코드
	                console.error("오류 발생:", xhr, status, error);
                }
            });           
            
            //결과 반환
            return result;
        }

        function searchStartMap() {
            var searchText = $("#tbStartMapSearch").val();
            searchText = $.trim(searchText);
            if(searchText) {
                psStart.keywordSearch(searchText, placesSearchCB);
            }
        }

        // 장소검색이 완료됐을 때 호출되는 콜백함수 입니다
        function placesSearchCB(data, status, pagination) {
            if(status === kakao.maps.services.Status.OK) { //정상 성공시
                displayPlaces(data);

                var center = map.getCenter();
                var lat = center.getLat();
                var lng = center.getLng();

                var xmlString = getStationByPositionSync(lng, lat);

                var parser = new DOMParser();
                var xmlDoc = parser.parseFromString(xmlString, "text/xml");

                var headerMsg = xmlDoc.getElementsByTagName("headerMsg")[0].childNodes[0].nodeValue;
                if(headerMsg != "정상적으로 처리되었습니다.") {
                    //오류 상황
                    alert(headerMsg);
                    return false;
                }

                removeMarker();

                var itemListElements = xmlDoc.getElementsByTagName("itemList");

                for(var i=0; i < itemListElements.length; i++) {
                    var item = itemListElements[i]; //각 아이템에 엑세스됨

                    var arsId = item.getElementsByTagName("arsId")[0].childNodes[0].nodeValue;   //정류소고유번호
                    var dist = item.getElementsByTagName("dist")[0].childNodes[0].nodeValue;         //거리
                    var gpsX = item.getElementsByTagName("gpsX")[0].childNodes[0].nodeValue;        //정류소 좌표X (WGS84) == lng
                    var gpsY = item.getElementsByTagName("gpsY")[0].childNodes[0].nodeValue;        //정류소 좌표Y (WGS84) == lat
                    var posX = item.getElementsByTagName("posX")[0].childNodes[0].nodeValue;        //정류소 좌표X (GRS80)
                    var posY = item.getElementsByTagName("posY")[0].childNodes[0].nodeValue;        //정류소 좌표Y (GRS80)
                    var stationId = item.getElementsByTagName("stationId")[0].childNodes[0].nodeValue;   //정류소 고유 ID
                    var stationNm = item.getElementsByTagName("stationNm")[0].childNodes[0].nodeValue;  //정류소명
                    var stationTp = item.getElementsByTagName("stationTp")[0].childNodes[0].nodeValue;  //정류소 타입 
                        //(0:공용, 1:일반형 시내/농어촌버스, 2:좌석형 시내/농어촌버스, 3:직행좌석형 시내/농어촌버스, 4:일반형 시외버스, 5:좌석형 시외버스, 6:고속형 시외버스, 7:마을버스)                    

                    var stationPosition = new kakao.maps.LatLng(gpsY, gpsX);

                    marker = addMarker(stationPosition, i);          
                    
                    // 마커와 검색결과 항목에 mouseover 했을때
                    // 해당 장소에 인포윈도우에 장소명을 표시합니다
                    // mouseout 했을 때는 인포윈도우를 닫습니다
                    (function(marker, title) {
                        kakao.maps.event.addListener(marker, 'mouseover', function(){
                            displayInfowindow(marker, title);
                        });

                        kakao.maps.event.addListener(marker, 'mouseout', function(){
                            infowindow.close();
                        });
                    })(marker, stationNm);                    
                }
            }
            else if(status === kakao.maps.services.Status.ZERO_RESULT) {  //검색 결과 없음
                alert("검색 결과가 존재하지 않습니다")
                return;
            }
            else if(status === kakao.maps.services.Status.ERROR) {  //오류 발생
                alert("검색 결과 중 오류가 발생했습니다")
                return;
            }
        }

        // 지도 위에 표시되고 있는 마커를 모두 제거합니다
        function removeMarker() {
            for ( var i = 0; i < markers.length; i++ ) {
                markers[i].setMap(null);
            }   
            markers = [];
        }        

        // 검색결과 목록 또는 마커를 클릭했을 때 호출되는 함수입니다
        // 인포윈도우에 장소명을 표시합니다
        function displayInfowindow(marker, title) {
            var content = '<div style="padding:5px;z-index:1;">' + title + '</div>';

            infowindow.setContent(content);
            infowindow.open(map, marker);
        }

        // 마커를 생성하고 지도 위에 마커를 표시하는 함수입니다
        function addMarker(position, idx) {
            var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png', // 마커 이미지 url, 스프라이트 이미지를 씁니다
                imageSize = new kakao.maps.Size(36, 37),  // 마커 이미지의 크기
                imgOptions =  {
                    spriteSize : new kakao.maps.Size(36, 691), // 스프라이트 이미지의 크기
                    spriteOrigin : new kakao.maps.Point(0, (idx*46)+10), // 스프라이트 이미지 중 사용할 영역의 좌상단 좌표
                    offset: new kakao.maps.Point(13, 37) // 마커 좌표에 일치시킬 이미지 내에서의 좌표
                },
                markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions),
                    marker = new kakao.maps.Marker({
                    position: position, // 마커의 위치
                    image: markerImage 
                });

            marker.setMap(map); // 지도 위에 마커를 표출합니다
            markers.push(marker);  // 배열에 생성된 마커를 추가합니다

            return marker;
        }             

        //지도에 마커 출력
        function displayPlaces(places) {
            var bounds = new kakao.maps.LatLngBounds();

            for(var i=0; i < places.length; i++) {
                var x = places[i].x;
                var y = places[i].y;
                var placePosition = new kakao.maps.LatLng(y, x);

                //LatLngBounds 객체에 좌표를 추가합니다
                bounds.extend(placePosition);
            }
            map.setBounds(bounds);
        }
    </script>
</head>    
<body>

    <div class="section" id="departure-section">
        <!-- 출발 정류소 섹션 내용 -->
        <div style="width:100%; display: inline-block;">
            <div style="float:left; width:200px">
                <h2>출발 정류소</h2>
            </div>
            <div style="float:left; padding-top:20px">
                <button class="find-button" onclick="findStartStation()">찾기</button>            
            </div>
        </div>

        <div style="width:100%; display: none;" id="mapContainer">
            <div style="width:100%; display: inline-box; text-align: center;">
                <input type="text" style="width:400px; height: 35px;" id="tbStartMapSearch"> <button class="find-search" onclick="searchStartMap();">키워드 검색</button>
            </div>
            <div style="width:100%; margin-top: 20px;">
                <div id="mapStart" style="width: 100%; height: 350px;"></div>
            </div>
        </div>        
    </div>
    
    <div class="section" id="departure-section">
        <!-- 도착 정류소 섹션 내용 -->
        <div style="width:100%; display: inline-block;">
            <div style="float:left; width:200px">
                <h2>도착 정류소</h2>
            </div>
            <div style="float:left; padding-top:20px">
                <button class="find-button">찾기</button>            
            </div>
        </div>
    
    </div>
    
    </body>
</html>